{% extends 'base.html' %}
{% block title %}Biểu 3 - KH 2026-2030{% endblock %}
{% block content %}
<style>
.bieu3-container {
    font-size: 0.85rem;
}
.bieu3-table-wrapper {
    max-height: 70vh;
    overflow: auto;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
}
.bieu3-table {
    font-size: 0.8rem;
    margin-bottom: 0;
}
.bieu3-table thead {
    position: sticky;
    top: 0;
    z-index: 10;
    background-color: #fff;
}
.bieu3-table thead th {
    background-color: #0d6efd;
    color: white;
    font-weight: 600;
    vertical-align: middle;
    padding: 0.5rem 0.3rem;
    white-space: nowrap;
}
.bieu3-table thead tr:first-child th {
    border-bottom: 2px solid #fff;
}
.cn-moi-header {
    background-color: #198754 !important;
}
.cn-lai-header {
    background-color: #fd7e14 !important;
}
.bieu3-table tbody td {
    padding: 0.4rem 0.3rem;
    vertical-align: middle;
}
.bieu3-table tbody td[contenteditable="true"] {
    cursor: text;
    background-color: #fff;
    transition: background-color 0.2s;
}
.bieu3-table tbody td[contenteditable="true"]:hover {
    background-color: #fff3cd;
    outline: 1px solid #ffc107;
}
.bieu3-table tbody td[contenteditable="true"]:focus {
    background-color: #e7f1ff;
    outline: 2px solid #0d6efd;
}
.sticky-col {
    position: sticky;
    background-color: #fff;
    z-index: 5;
}
.col-checkbox { left: 0; width: 35px; }
.col-stt { left: 35px; width: 45px; }
.col-ward { left: 80px; min-width: 100px; max-width: 120px; }
.col-school { left: 200px; min-width: 180px; max-width: 220px; }
.btn-action-group {
    white-space: nowrap;
}
.year-col {
    min-width: 50px;
    max-width: 60px;
    text-align: center;
}
</style>

<div class="bieu3-container">
<h2 class="mb-3">
    <i class="bi bi-calendar-range"></i> Biểu 3 - KẾ HOẠCH CÔNG NHẬN MỚI VÀ CÔNG NHẬN LẠI 2026-2030
</h2>
<div class="card mb-3">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <span class="badge bg-info">Tổng: {{ records.count }} trường</span>
                <span class="badge bg-success ms-2">Công nhận mới</span>
                <span class="badge bg-warning text-dark">Công nhận lại</span>
            </div>
            <div>
                <a href="{% url 'bieu3_import' %}" class="btn btn-sm btn-primary">
                    <i class="bi bi-upload"></i> Import
                </a>
                <a href="{% url 'bieu3_export' %}" class="btn btn-sm btn-success">
                    <i class="bi bi-download"></i> Xuất Excel
                </a>
                <button class="btn btn-sm btn-danger" onclick="deleteSelected()">
                    <i class="bi bi-trash"></i> Xóa đã chọn
                </button>
            </div>
        </div>
    </div>
</div>

<div class="bieu3-table-wrapper">
<table class="table table-bordered bieu3-table">
<thead>
<tr>
<th rowspan="2" class="sticky-col col-checkbox"><input type="checkbox" id="selectAll" onclick="toggleAll(this)"></th>
<th rowspan="2" class="sticky-col col-stt">STT</th>
<th rowspan="2" class="sticky-col col-ward">Phường/Xã</th>
<th rowspan="2" class="sticky-col col-school">Tên trường</th>
<th rowspan="2">Cấp học</th>
<th rowspan="2">Loại hình</th>
<th rowspan="2">Năm CQG</th>
<th colspan="5" class="text-center cn-moi-header">Công nhận mới</th>
<th colspan="5" class="text-center cn-lai-header">Công nhận lại</th>
<th rowspan="2">Ghi chú</th>
<th rowspan="2">Hành động</th>
</tr>
<tr>
<th class="cn-moi-header">2026</th>
<th class="cn-moi-header">2027</th>
<th class="cn-moi-header">2028</th>
<th class="cn-moi-header">2029</th>
<th class="cn-moi-header">2030</th>
<th class="cn-lai-header">2026</th>
<th class="cn-lai-header">2027</th>
<th class="cn-lai-header">2028</th>
<th class="cn-lai-header">2029</th>
<th class="cn-lai-header">2030</th>
</tr>
</thead>
<tbody>
{% for r in records %}
<tr id="row-{{ r.id }}">
<td class="sticky-col col-checkbox"><input type="checkbox" class="row-select" value="{{ r.id }}"></td>
<td class="sticky-col col-stt">{{ r.ward.stt }}</td>
<td class="sticky-col col-ward">{{ r.ward.don_vi }}</td>
<td class="sticky-col col-school" contenteditable="true" data-field="ten_truong" title="Click để chỉnh sửa">{{ r.ten_truong }}</td>
<td contenteditable="true" data-field="cap_hoc" style="min-width: 80px;">{{ r.cap_hoc }}</td>
<td contenteditable="true" data-field="loai_hinh" style="min-width: 80px;">{{ r.loai_hinh }}</td>
<td contenteditable="true" data-field="nam_dat_cqg_gan_nhat" class="text-center" style="min-width: 70px;">{{ r.nam_dat_cqg_gan_nhat|default:'' }}</td>
<td contenteditable="true" data-field="cn_moi_2026" class="year-col">{{ r.cn_moi_2026|default:'' }}</td>
<td contenteditable="true" data-field="cn_moi_2027" class="year-col">{{ r.cn_moi_2027|default:'' }}</td>
<td contenteditable="true" data-field="cn_moi_2028" class="year-col">{{ r.cn_moi_2028|default:'' }}</td>
<td contenteditable="true" data-field="cn_moi_2029" class="year-col">{{ r.cn_moi_2029|default:'' }}</td>
<td contenteditable="true" data-field="cn_moi_2030" class="year-col">{{ r.cn_moi_2030|default:'' }}</td>
<td contenteditable="true" data-field="cn_lai_2026" class="year-col">{{ r.cn_lai_2026|default:'' }}</td>
<td contenteditable="true" data-field="cn_lai_2027" class="year-col">{{ r.cn_lai_2027|default:'' }}</td>
<td contenteditable="true" data-field="cn_lai_2028" class="year-col">{{ r.cn_lai_2028|default:'' }}</td>
<td contenteditable="true" data-field="cn_lai_2029" class="year-col">{{ r.cn_lai_2029|default:'' }}</td>
<td contenteditable="true" data-field="cn_lai_2030" class="year-col">{{ r.cn_lai_2030|default:'' }}</td>
<td contenteditable="true" data-field="ghi_chu" style="min-width: 75px; max-width: 100px;">{{ r.ghi_chu|default:'' }}</td>
<td class="btn-action-group" style="min-width: 130px;">
<button class="btn btn-sm btn-success mb-1" onclick="saveRow({{ r.id }})" title="Lưu thay đổi">
    <i class="bi bi-check-lg"></i> Lưu
</button>
<button class="btn btn-sm btn-danger mb-1" onclick="deleteRow({{ r.id }})" title="Xóa dòng này">
    <i class="bi bi-trash"></i> Xóa
</button>
</td>
</tr>
{% empty %}
<tr><td colspan="18" class="text-center text-muted py-3">
    <i class="bi bi-inbox"></i> Chưa có dữ liệu
</td></tr>
{% endfor %}
</tbody>
</table>
</div>
</div>

<script>
function getCookie(name) {
    let value = `; ${document.cookie}`;
    let parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}

function toggleAll(checkbox) {
    document.querySelectorAll('.row-select').forEach(cb => cb.checked = checkbox.checked);
}

function saveRow(id) {
    const row = document.getElementById(`row-${id}`);
    const fields = ['ten_truong', 'cap_hoc', 'loai_hinh', 'nam_dat_cqg_gan_nhat',
                    'cn_moi_2026', 'cn_moi_2027', 'cn_moi_2028', 'cn_moi_2029', 'cn_moi_2030',
                    'cn_lai_2026', 'cn_lai_2027', 'cn_lai_2028', 'cn_lai_2029', 'cn_lai_2030',
                    'ghi_chu'];
    const data = {};
    fields.forEach(field => {
        const el = row.querySelector(`[data-field="${field}"]`);
        if(el) data[field] = el.textContent.trim();
    });
    
    // Show loading state
    const saveBtn = event.target;
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Đang lưu...';
    saveBtn.disabled = true;
    
    fetch(`/bieu3/update/${id}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    }).then(r => r.json()).then(data => {
        if(data.status === 'success') {
            // Success animation
            row.style.backgroundColor = '#d4edda';
            saveBtn.innerHTML = '<i class="bi bi-check-circle"></i> Đã lưu!';
            setTimeout(() => {
                row.style.backgroundColor = '';
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }, 2000);
        } else {
            alert('Lỗi: ' + (data.message || 'Không thể lưu'));
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
        }
    }).catch(err => {
        alert('Lỗi kết nối: ' + err);
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    });
}

function deleteRow(id) {
    if(!confirm('Xác nhận xóa trường này?')) return;
    fetch(`/bieu3/delete/${id}/`, {
        method: 'POST',
        headers: {'X-CSRFToken': getCookie('csrftoken')}
    }).then(() => {
        const row = document.getElementById(`row-${id}`);
        row.style.backgroundColor = '#f8d7da';
        setTimeout(() => row.remove(), 300);
    }).catch(err => alert('Lỗi: ' + err));
}

function deleteSelected() {
    const selected = Array.from(document.querySelectorAll('.row-select:checked')).map(cb => cb.value);
    if(selected.length === 0) {
        alert('Vui lòng chọn ít nhất 1 dòng để xóa!');
        return;
    }
    if(!confirm(`Xác nhận xóa ${selected.length} trường đã chọn?`)) return;
    
    fetch('/bieu3/delete-multiple/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ids: selected})
    }).then(r => r.json()).then(data => {
        selected.forEach(id => {
            const row = document.getElementById(`row-${id}`);
            if(row) {
                row.style.backgroundColor = '#f8d7da';
                setTimeout(() => row.remove(), 300);
            }
        });
        setTimeout(() => {
            alert(`Đã xóa ${data.deleted} trường!`);
            document.getElementById('selectAll').checked = false;
        }, 400);
    }).catch(err => alert('Lỗi: ' + err));
}

// Add keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + S to save current focused row
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        const focusedCell = document.activeElement;
        if (focusedCell.hasAttribute('contenteditable')) {
            const row = focusedCell.closest('tr');
            if (row && row.id.startsWith('row-')) {
                const id = row.id.replace('row-', '');
                saveRow(id);
            }
        }
    }
});
</script>
{% endblock %}
